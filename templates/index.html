<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å¹¸è¿è½¬ç›˜æ¸¸æˆ</title>
  <style>
    body { text-align: center; font-family: Arial, sans-serif; background: #f9f9f9; }
    .wheel { width: 300px; height: 300px; border-radius: 50%; border: 10px solid #333;
             margin: 20px auto; transition: transform 4s cubic-bezier(0.33, 1, 0.68, 1);
             position: relative; overflow: hidden; }
    .wheel div { position: absolute; width: 50%; height: 50%; transform-origin: 100% 100%;
                 border: 1px solid #333; }
    .arrow { width: 0; height: 0; border-left: 20px solid transparent;
             border-right: 20px solid transparent; border-bottom: 40px solid red;
             position: absolute; top: -40px; left: calc(50% - 20px); }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    #result { margin-top: 20px; font-size: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>å¹¸è¿è½¬ç›˜ ğŸ¯</h1>
  <div style="position: relative; width: 300px; margin: auto;">
    <div class="arrow"></div>
    <div class="wheel" id="wheel"></div>
  </div>

  <button onclick="spin()">å¼€å§‹æŠ½å¥–</button>
  <div id="result"></div>

  <h2>é…ç½®å¥–å“</h2>
  <textarea id="prizeInput" rows="4" cols="40" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šä¸€ç­‰å¥–,äºŒç­‰å¥–,è°¢è°¢å‚ä¸"></textarea><br>
  <button onclick="updatePrizes()">æ›´æ–°å¥–å“</button>

  <script>
    let wheel = document.getElementById("wheel");
    let isSpinning = false;
    let currentPrizes = ["è‹¹æœ", "é¦™è•‰", "çº¢åŒ…", "æ‰‹è¡¨", "ç”µè¯", "è°¢è°¢å‚ä¸"];

    // ç»˜åˆ¶è½¬ç›˜
    function renderWheel() {
      wheel.innerHTML = "";
      let count = currentPrizes.length;
      for (let i = 0; i < count; i++) {
        let slice = document.createElement("div");
        slice.style.background = `hsl(${i * (360 / count)}, 70%, 70%)`;
        slice.style.transform = `rotate(${i * (360 / count)}deg) skewY(-${90 - 360/count}deg)`;
        wheel.appendChild(slice);
      }
    }

    renderWheel();

    async function spin() {
      if (isSpinning) return;
      isSpinning = true;

      let response = await fetch("/spin");
      let data = await response.json();

      if (data.index === -1) {
        document.getElementById("result").innerText = data.prize;
        isSpinning = false;
        return;
      }

      let prizeIndex = data.index;
      let prizeName = data.prize;
      let count = currentPrizes.length;

      // è½¬ç›˜æ—‹è½¬è§’åº¦
      let degrees = 360 * 5 + (360 - prizeIndex * (360/count) - (180/count));
      wheel.style.transform = `rotate(${degrees}deg)`;

      setTimeout(() => {
        document.getElementById("result").innerText = "ç»“æœï¼š" + prizeName;
        isSpinning = false;
      }, 4500);
    }

    async function updatePrizes() {
      let input = document.getElementById("prizeInput").value.trim();
      if (!input) return alert("è¯·è¾“å…¥å¥–å“åˆ—è¡¨ï¼");
      let newPrizes = input.split(",").map(s => s.trim()).filter(s => s);

      let response = await fetch("/set_prizes", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({prizes: newPrizes})
      });

      let data = await response.json();
      if (data.status === "ok") {
        currentPrizes = data.prizes;
        renderWheel();
        alert("å¥–å“å·²æ›´æ–°ï¼");
      } else {
        alert("æ›´æ–°å¤±è´¥ï¼š" + data.message);
      }
    }
  </script>
</body>
</html>
